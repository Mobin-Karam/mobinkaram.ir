export const meta = {
  slug: "koonj",
  title: "Koonj — community + payments platform",
  summary:
    "Mobile app for small communities to run paid memberships, live events, and gated content.",
  tags: ["React Native", "NestJS", "PostgreSQL", "Realtime"],
  stack: ["Expo", "NestJS", "PostgreSQL", "Redis", "tRPC"],
  year: "2025-2026",
  status: "Phase 2",
  featured: true,
  date: "2026-02-01",
  author: "Mobin Karam",
  authorAvatar: "",
  readingMinutes: 6,
  cover: "/koonj-logo.jpg",
};

# Problem
Small Iranian communities lack reliable, compliant infrastructure for subscriptions, roles, and live events. Telegram/WhatsApp are brittle for payments and governance.

# Architecture
- **Client:** Expo (React Native) + React Query. Offline-first with IndexedDB (web) and AsyncStorage (native).
- **Gateway:** tRPC over HTTP with websocket presence channel.
- **Backend:** NestJS (modular), CQRS for financial flows, background workers for payouts.
- **Data:** PostgreSQL (Timescale for events), Redis for cache/queue, S3 for assets.
- **Observability:** OpenTelemetry + Honeycomb, Sentry, Grafana Loki for logs.

```text
[Expo App] --tRPC--> [Gateway] --HTTP--> [NestJS Services] --SQL--> [PostgreSQL]
      \\__ websocket presence __> [Redis pub/sub]
```

# Tech decisions
- Dropped in-app purchases; moved to Zarinpal secure links + webhooks to avoid store risk.
- Membership model redesigned to “Membership Snapshot” for price/version history.
- Navigation moved to hybrid tabs + modals for discoverability and deep links.

# Challenges
- First real-time presence with Socket.IO leaked memory; migrated to `ws` with custom heartbeat.
- FCM delivery issues in Iran — added email + in-app inbox as fallback.

# Security considerations
- Tokens rotate every 30 minutes; refresh tokens bound to device fingerprint.
- Role/capability matrix enforced at service layer; audit tables for all money movements.
- Webhooks signed + replay-protected; file uploads scanned and served via signed URLs.

# Deployment
- Dockerized services on VPS behind Nginx with TLS; blue/green deploys via GitHub Actions.
- Nightly PostgreSQL dumps + object-storage backups; synthetic health checks per release.

# Lessons learned
- CQRS around money made debugging safe and auditable.
- Aggressive prefetch on community screen kept first interaction under 300ms.
- Shipping observability in Sprint 1 prevented outages later.

# Next
- Phase 2: plugin marketplace for communities (role automation + payment analytics).
